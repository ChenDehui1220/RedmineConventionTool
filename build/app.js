$(function(){"use strict";function n(){$(".custom").each(function(){var n=!0,t=!1;$(this).mouseover(function(){var a=$(this);n=!0,setTimeout(function(){if(n===!0&&!t){var i=$("<span>");i.attr({"class":"del","data-tag":a.html()}).html("X").on({mouseenter:function(){n=!1},mouseleave:function(){n=!0,t=!1,$(this).remove()},click:function(n){n.preventDefault();var t=$(this),a=t.data("tag"),i=t.parent(".pool").find("label").attr("for");t.prev().remove(),e(i,a),n.stopPropagation()}}),a.after(i),t=!0}},1500)}).mouseleave(function(){n=!1;var e=$(this);setTimeout(function(){n||(e.next(".del").remove(),t=!1)},800)})})}function t(n,t){v[n].push(t),a()}function e(n,t){var e=v[n];e.splice(e.indexOf(t),1),a()}function a(){chrome.storage.sync.set({data:v})}function i(){var t=v;for(var e in t)if(t[e].length>0){var a=$(".tg-"+e),i="";for(var r in t[e]){i+=b(t[e][r],!0);for(var o in h)if(h[o].arg===e){h[o].data.push(t[e][r]);break}}a.find(".plus").before(i)}n()}function r(){chrome.storage.sync.get("data",function(n){0===Object.keys(n).length?a():(v=n.data,i())})}var o=$(".nav"),s=$(".tabscontent"),c=$(".containter"),f=$("#submit"),u=$("#options"),l=($("#error"),[]),h=[],v={},d=0,p=["ticket","reply"],m=0,g="./ec_redmine_convention_options_data.json",b=function(n,t){var e=void 0!==t&&t===!0?"custom":"";return'<a href="#" class="tag '+e+'">'+n+"</a>"},k=function(){var n=function(){var n="",t="",e="";for(var a in h){t=h[a].require?"require":"",e=h[a].arg,v[e]=[],n+='<div class="pool '+t+" tg-"+e+'"><label for="'+h[a].arg+'">'+h[a].name+" : </label>";for(var i in h[a].data)n+=b(h[a].data[i]);n+='<a href="#" class="plus">+</a>',n+="</div>"}u.html(n)};$.ajax({url:g,dataType:"json",cache:!1,success:function(t){"object"==typeof t&&Object.keys(t).length>0&&t.data.length>0&&(h=t.data[0].options,n(t),r())}})};k();var y=function(){if(l=[],0===m)c.find(".pool").each(function(){$(this).find("a").each(function(){$(this).hasClass("in")&&l.push($(this).html())})});else if(1===m){var n="h3. [更動範圍]\r\n";n+="模組:\r\n行為類型:\r\n異動點:\r\n\r\n",n+="h3. [複雜度]\r\n普通級\r\n\r\n",n+="h3. [預計處理步驟]\r\n...\r\n\r\n",n+="h3. [預計測試範圍]\r\n...\r\n\r\n",n+="h3. [實際處理步驟]\r\n...\r\n\r\n",n+="h3. [Code Commit Id]\r\n無\r\n\r\n",n+="h3. [DB異動]\r\n無\r\n\r\n",n+="h3. [產出相關文件]\r\n無\r\n\r\n",l.push(n)}},j=function(){var n=!0;if(0===m){var t=!1;if(0===l.length)n=!1;else for(var e in h)if(h[e].require===!0){t=!1;for(var a in h[e].data)if(-1!==l.indexOf(h[e].data[a])){t=!0;break}if(!t){n=!1;break}}}return n};chrome.tabs.query({active:!0,currentWindow:!0},function(n){/pm\.hq\.hiiir\/(projects|issues)\/(.*)/i.test(n[0].url)?(d=n[0].id,chrome.tabs.executeScript(d,{file:"content_scripts.js"},function(){chrome.tabs.sendMessage(d,{action:"init"},function(n){"object"==typeof n&&n.user&&setTimeout(function(){var t="";n&&n.nowtag&&n.nowtag.length>0&&(t=n.nowtag[0]),t=t.replace(/\]\[/g,"-"),t=t.replace("]",""),t=t.replace("[",""),t=t.split("-"),u.find("a").each(function(){-1!==t.indexOf($(this).html())&&$(this).addClass("in")})},50)})})):c.html('<span class="nosupport">不支持此網頁使用!!!</span>')});var C=function(n){var t=n.index();o.find("li").removeClass("active"),n.addClass("active"),s.hide(),s.eq(t).show(),m=t},x=function(n){n.focus(),n.on("blur",function(){var n=$(this),e=n.parent("a");if(""===n.val())e.remove();else{var a=e.parent(".pool").find("label").attr("for"),i=n.val().trim();t(a,i),e.attr("class","tag"),e.html(i)}})};o.on("click","li",function(n){n.preventDefault(),C($(this))}),o.find("li:eq(0)").trigger("click"),c.on("click","a.tag",function(n){n.preventDefault(),$(this).hasClass("in")?$(this).removeClass("in"):$(this).addClass("in")}),c.on("click","a.plus",function(n){n.preventDefault();var t=$(this).parent(".pool");0===t.find("input").length&&($(this).before('<a href="#"><input type="text" /></a>'),x(t.find("input")))}),f.on("click",function(){y(),j()&&chrome.tabs.sendMessage(d,{action:p[m],data:l},function(n){validTimes=0})})});